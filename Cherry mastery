-- 基本服務與玩家
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- GUI 主體
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "MaolingHub"

-- 修正：主框架樣式
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 450, 0, 350)
Frame.Position = UDim2.new(0.5, -225, 0.5, -175)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true

-- 添加漸層效果
local gradient = Instance.new("UIGradient", Frame)
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(25, 25, 35)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(35, 35, 50))
}
gradient.Rotation = 45

-- 添加外發光效果
local stroke = Instance.new("UIStroke", Frame)
stroke.Color = Color3.fromRGB(100, 150, 255)
stroke.Thickness = 2
stroke.Transparency = 0.5

Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 15)

-- 修正：標題樣式
local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1, -80, 0, 50)
Title.Position = UDim2.new(0, 15, 0, 0)  -- 往上移動5像素原為5
Title.BackgroundTransparency = 1
Title.Text = "✨ 貓玲的腳本區 ✨v0.08"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextXAlignment = Enum.TextXAlignment.Left

-- 添加標題發光效果
local titleStroke = Instance.new("UIStroke", Title)
titleStroke.Color = Color3.fromRGB(100, 150, 255)
titleStroke.Thickness = 1
titleStroke.Transparency = 0.3

-- 修正：關閉按鈕樣式和功能
local Close = Instance.new("TextButton", Frame)
Close.Size = UDim2.new(0, 35, 0, 35)
Close.Position = UDim2.new(1, -40, 0, 8)
Close.Text = "x"
Close.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
Close.TextColor3 = Color3.fromRGB(255, 255, 255)
Close.Font = Enum.Font.GothamBold
Close.TextSize = 18
Close.BorderSizePixel = 0

-- 添加關閉按鈕效果
local closeGradient = Instance.new("UIGradient", Close)
closeGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(220, 60, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 40, 40))
}

Instance.new("UICorner", Close).CornerRadius = UDim.new(0, 8)

-- 修正：關閉按鈕功能
Close.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    _G.maolingHubLoaded = false -- 重置載入狀態
end)

-- 修正：最小化按鈕樣式
local Minimize = Instance.new("TextButton", Frame)
Minimize.Size = UDim2.new(0, 35, 0, 35)
Minimize.Position = UDim2.new(1, -80, 0, 8)
Minimize.Text = "─"
Minimize.BackgroundColor3 = Color3.fromRGB(100, 100, 120)
Minimize.TextColor3 = Color3.fromRGB(255, 255, 255)
Minimize.Font = Enum.Font.GothamBold
Minimize.TextSize = 16
Minimize.BorderSizePixel = 0

local minimizeGradient = Instance.new("UIGradient", Minimize)
minimizeGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 100, 120)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 100))
}

Instance.new("UICorner", Minimize).CornerRadius = UDim.new(0, 8)

-- 修正：側邊欄為可滾動
local SideBar = Instance.new("ScrollingFrame", Frame)
SideBar.Size = UDim2.new(0, 130, 1, -55)
SideBar.Position = UDim2.new(0, 5, 0, 50)
SideBar.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
SideBar.BorderSizePixel = 0
SideBar.ScrollBarThickness = 6
SideBar.CanvasSize = UDim2.new(0, 0, 0, 200)
SideBar.AutomaticCanvasSize = Enum.AutomaticSize.Y
SideBar.ScrollingDirection = Enum.ScrollingDirection.Y

-- 添加側邊欄樣式
local sidebarGradient = Instance.new("UIGradient", SideBar)
sidebarGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 50)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 45, 65))
}

Instance.new("UICorner", SideBar).CornerRadius = UDim.new(0, 10)

-- 添加UIListLayout到側邊欄
local sidebarLayout = Instance.new("UIListLayout", SideBar)
sidebarLayout.Padding = UDim.new(0, 8)
sidebarLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- 修正：內容區域
local Content = Instance.new("Frame", Frame)
Content.Size = UDim2.new(1, -145, 1, -55)
Content.Position = UDim2.new(0, 140, 0, 50)
Content.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
Content.BorderSizePixel = 0

local contentGradient = Instance.new("UIGradient", Content)
contentGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 75))
}

Instance.new("UICorner", Content).CornerRadius = UDim.new(0, 10)

-- 修正：縮小功能的尺寸
local isMinimized = false
local fullSize = UDim2.new(0, 450, 0, 350)
local miniSize = UDim2.new(0, 450, 0, 50)

Minimize.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    SideBar.Visible = not isMinimized
    Content.Visible = not isMinimized
    Frame.Size = isMinimized and miniSize or fullSize
end)

-- 修正：簡單高亮文字的分區按鈕樣式
local function createSectionButton(text, order, parent)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0, 120, 0, 45)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(85, 85, 105)  -- 比原本更亮的背景
    
    -- 最亮的文字設定
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 純白色
    btn.TextTransparency = 0  -- 完全不透明
    btn.Font = Enum.Font.GothamBold  -- 粗體字
    btn.TextSize = 16  -- 適中大小
    btn.BorderSizePixel = 0
    
    -- 移除漸層，使用純色背景
    -- 這樣文字會更清楚
    
    -- 添加圓角
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
    
    -- 簡化描邊
    local btnStroke = Instance.new("UIStroke", btn)
    btnStroke.Color = Color3.fromRGB(150, 180, 255)
    btnStroke.Thickness = 1
    btnStroke.Transparency = 0.6
    
    -- 簡單hover效果
    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(105, 105, 125)  -- hover時更亮
        btnStroke.Transparency = 0.3
    end)
    
    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(85, 85, 105)
        btnStroke.Transparency = 0.6
    end)
    
    return btn
end


-- 修正：簡單高亮文字的一般按鈕樣式
local function createButton(text, order, parent, spacing)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0, 180, 0, 35)
    btn.Position = UDim2.new(0.5, -90, 0, 10 + (order - 1) * spacing)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)  -- 比原本更亮的背景
    
    -- 最亮的文字設定
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 純白色
    btn.TextSize = 16  -- 適中大小
    btn.Font = Enum.Font.GothamBold  -- 粗體字
    btn.BorderSizePixel = 0
    
    -- 移除漸層，使用純色背景讓文字更清楚
    
    -- 添加圓角
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    
    -- 簡化描邊
    local btnStroke = Instance.new("UIStroke", btn)
    btnStroke.Color = Color3.fromRGB(120, 170, 255)
    btnStroke.Thickness = 1
    btnStroke.Transparency = 0.6
    
    -- 簡單hover效果
    btn.MouseEnter:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(100, 160, 240)  -- hover時更亮
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 保持純白
        btnStroke.Transparency = 0.3
    end)
    
    btn.MouseLeave:Connect(function()
        btn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 保持純白
        btnStroke.Transparency = 0.6
    end)
    
    return btn
end


-- 添加滾動框樣式改善
local function styleScrollFrame(scrollFrame)
    scrollFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 65)
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 150, 255)
    
    local scrollGradient = Instance.new("UIGradient", scrollFrame)
    scrollGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(45, 45, 65)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(55, 55, 80))
    }
    
    Instance.new("UICorner", scrollFrame).CornerRadius = UDim.new(0, 8)
end

-- 櫻桃精通分區腳本

-- 創建櫻桃分區按鈕
local Section6 = createSectionButton("櫻桃精通", 2, SideBar)

-- 創建櫻桃分區的ScrollingFrame
local cherrySection = Instance.new("ScrollingFrame", Content)
cherrySection.Size = UDim2.new(1, 0, 1, 0)
cherrySection.CanvasSize = UDim2.new(0, 0, 0, 400)
cherrySection.ScrollBarThickness = 6
cherrySection.BackgroundTransparency = 1
cherrySection.Visible = true  -- 預設顯示
cherrySection.AutomaticCanvasSize = Enum.AutomaticSize.Y
cherrySection.VerticalScrollBarInset = Enum.ScrollBarInset.ScrollBar
cherrySection.ScrollingDirection = Enum.ScrollingDirection.Y

-- 應用滾動框樣式
styleScrollFrame(cherrySection)

-- 櫻桃功能變數
local isCherryAutoEnabled = false
local cherryAutoLoop = nil
local isCherryHelpEnabled = false
local cherryHelpLoop = nil
local cherryHelpMode = "第一、二任務" -- 預設模式
local cherryPlayerInput = nil
local isCherryMovingLocked = false

-- 創建自動使用櫻桃能力按鈕
local cherryAutoBtn = createButton("自動使用能力: 關", 1, cherrySection, 50)

-- 自動使用櫻桃能力按鈕功能
cherryAutoBtn.MouseButton1Click:Connect(function()
    isCherryAutoEnabled = not isCherryAutoEnabled
    cherryAutoBtn.Text = isCherryAutoEnabled and "自動使用能力: 開" or "自動使用能力: 關"
    
    if isCherryAutoEnabled then
        cherryAutoLoop = task.spawn(function()
            while isCherryAutoEnabled do
                -- 執行櫻桃能力
                pcall(function()
                    game:GetService("ReplicatedStorage").GeneralAbility:FireServer()
                end)
                
                -- 每0.7秒執行分身攻擊（統一間隔）
                local startTime = tick()
                while isCherryAutoEnabled and (tick() - startTime < 5) do
                    pcall(function()
                        local cherryStorage = workspace:FindFirstChild("cherry_storage")
                        if cherryStorage then
                            -- 找到所有櫻桃分身並執行clone_remote
                            for _, child in pairs(cherryStorage:GetChildren()) do
                                if child.Name == "Cherry " .. LocalPlayer.Name and child:FindFirstChild("clone_remote") then
                                    child.clone_remote:FireServer()
                                end
                            end
                        end
                    end)
                    task.wait(0.7) -- 分身攻擊間隔改為0.7秒
                end
                
                -- 每0.7秒攻擊7單位內最近玩家
                task.spawn(function()
                    while isCherryAutoEnabled do
                        pcall(function()
                            -- 找到5單位內最近的玩家
                            local nearestPlayer = nil
                            local nearestDistance = math.huge
                            local myCharacter = LocalPlayer.Character
                            
                            if myCharacter and myCharacter:FindFirstChild("HumanoidRootPart") then
                                for _, player in pairs(game:GetService("Players"):GetPlayers()) do
                                    if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                                        local distance = (myCharacter.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                                        -- 只攻擊7單位內的玩家
                                        if distance <= 7 and distance < nearestDistance then
                                            nearestDistance = distance
                                            nearestPlayer = player
                                        end
                                    end
                                end
                            end
                            
                            if nearestPlayer and nearestPlayer.Character and nearestPlayer.Character:FindFirstChild("Torso") then
                                local args = {
                                    [1] = nearestPlayer.Character.Torso
                                }
                                game:GetService("ReplicatedStorage").GeneralHit:FireServer(unpack(args))
                            end
                        end)
                        task.wait(0.7)
                    end
                end)
                
                if not isCherryAutoEnabled then break end
            end
        end)
    elseif cherryAutoLoop then
        task.cancel(cherryAutoLoop)
        cherryAutoLoop = nil
    end
end)

-- 創建櫻桃幫助模式按鈕
local cherryHelpBtn = createButton("幫助模式: 關", 2, cherrySection, 50)
cherryHelpBtn.Position = UDim2.new(0.5, -90, 0, 60)

-- 創建櫻桃玩家名稱輸入框
local cherryInputFrame = Instance.new("Frame", cherrySection)
cherryInputFrame.Size = UDim2.new(0, 180, 0, 25)
cherryInputFrame.Position = UDim2.new(0.5, -90, 0, 105)
cherryInputFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
cherryInputFrame.BorderSizePixel = 0
Instance.new("UICorner", cherryInputFrame).CornerRadius = UDim.new(0, 6)

-- 創建櫻桃輸入框
local cherryPlayerInput = Instance.new("TextBox", cherryInputFrame)
cherryPlayerInput.Size = UDim2.new(1, -10, 1, -4)
cherryPlayerInput.Position = UDim2.new(0, 5, 0, 2)
cherryPlayerInput.BackgroundTransparency = 1
cherryPlayerInput.Text = "輸入玩家名稱"
cherryPlayerInput.TextColor3 = Color3.fromRGB(200, 200, 200)
cherryPlayerInput.TextSize = 12
cherryPlayerInput.Font = Enum.Font.Gotham
cherryPlayerInput.ClearTextOnFocus = true

-- 創建櫻桃幫助模式下拉選單
local cherryHelpDropdown = Instance.new("TextButton", cherrySection)
cherryHelpDropdown.Size = UDim2.new(0, 180, 0, 25)
cherryHelpDropdown.Position = UDim2.new(0.5, -90, 0, 135)
cherryHelpDropdown.Text = "模式: " .. cherryHelpMode
cherryHelpDropdown.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
cherryHelpDropdown.TextColor3 = Color3.fromRGB(255, 255, 255)
cherryHelpDropdown.TextSize = 14
cherryHelpDropdown.Font = Enum.Font.Gotham
cherryHelpDropdown.BorderSizePixel = 0
Instance.new("UICorner", cherryHelpDropdown).CornerRadius = UDim.new(0, 6)

-- 櫻桃幫助模式選項框架
local cherryHelpOptions = Instance.new("Frame", cherrySection)
cherryHelpOptions.Size = UDim2.new(0, 180, 0, 60)
cherryHelpOptions.Position = UDim2.new(0.5, -90, 0, 160)
cherryHelpOptions.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
cherryHelpOptions.BorderSizePixel = 0
cherryHelpOptions.Visible = false
Instance.new("UICorner", cherryHelpOptions).CornerRadius = UDim.new(0, 6)

-- 櫻桃被打後重置選項
local cherryResetOption = Instance.new("TextButton", cherryHelpOptions)
cherryResetOption.Size = UDim2.new(1, 0, 0.5, 0)
cherryResetOption.Position = UDim2.new(0, 0, 0, 0)
cherryResetOption.Text = "第一、二任務"
cherryResetOption.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
cherryResetOption.TextColor3 = Color3.fromRGB(255, 255, 255)
cherryResetOption.TextSize = 12
cherryResetOption.Font = Enum.Font.Gotham
cherryResetOption.BorderSizePixel = 0

-- 櫻桃被打後不重置選項
local cherryNoResetOption = Instance.new("TextButton", cherryHelpOptions)
cherryNoResetOption.Size = UDim2.new(1, 0, 0.5, 0)
cherryNoResetOption.Position = UDim2.new(0, 0, 0.5, 0)
cherryNoResetOption.Text = "第三、四任務"
cherryNoResetOption.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
cherryNoResetOption.TextColor3 = Color3.fromRGB(255, 255, 255)
cherryNoResetOption.TextSize = 12
cherryNoResetOption.Font = Enum.Font.Gotham
cherryNoResetOption.BorderSizePixel = 0

-- 櫻桃幫助模式下拉選單功能
cherryHelpDropdown.MouseButton1Click:Connect(function()
    cherryHelpOptions.Visible = not cherryHelpOptions.Visible
end)

cherryResetOption.MouseButton1Click:Connect(function()
    cherryHelpMode = "第一、二任務"
    cherryHelpDropdown.Text = "模式: " .. cherryHelpMode
    cherryHelpOptions.Visible = false
end)

cherryNoResetOption.MouseButton1Click:Connect(function()
    cherryHelpMode = "第三、四任務"
    cherryHelpDropdown.Text = "模式: " .. cherryHelpMode
    cherryHelpOptions.Visible = false
end)

-- 檢測ragdoll狀態的函數
local function isInRagdoll(character)
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    
    if not humanoidRootPart or not humanoid then return false end
    
    -- 檢查是否處於ragdoll狀態
    return humanoid:GetState() == Enum.HumanoidStateType.Ragdoll or
           humanoid:GetState() == Enum.HumanoidStateType.FallingDown or
           humanoid.PlatformStand == true
end

-- 尋找目標手套的函數
local function findTargetGlove(targetName)
    local cherryStorage = workspace:FindFirstChild("cherry_storage")
    if not cherryStorage then return nil end
    
    -- 遍歷所有櫻桃尋找包含目標名稱的手套
    for _, child in pairs(cherryStorage:GetChildren()) do
        if child.Name:find(targetName) and child:FindFirstChild("Cherry") then
            local cherry = child.Cherry
            if cherry:FindFirstChild("Glove") then
                return cherry.Glove
            end
        end
    end
    
    return nil
end

-- 櫻桃幫助模式功能
cherryHelpBtn.MouseButton1Click:Connect(function()
    isCherryHelpEnabled = not isCherryHelpEnabled
    cherryHelpBtn.Text = isCherryHelpEnabled and "幫助模式: 開" or "幫助模式: 關"
    
    if isCherryHelpEnabled then
        local targetName = cherryPlayerInput.Text
        if targetName == "" or targetName == "輸入玩家名稱" then
            cherryHelpBtn.Text = "幫助模式: 關"
            isCherryHelpEnabled = false
            return
        end
        
        cherryHelpLoop = task.spawn(function()
            while isCherryHelpEnabled do
                local character = LocalPlayer.Character
                if not character then
                    character = LocalPlayer.CharacterAdded:Wait()
                end
                
                local humanoidRootPart = character:WaitForChild("HumanoidRootPart", 10)
                local humanoid = character:WaitForChild("Humanoid", 10)
                
                if not humanoidRootPart or not humanoid then
                    task.wait(0.5)
                    continue
                end
                
                if humanoid.Health <= 0 then
                    task.wait(0.3)
                    continue
                end
                
                pcall(function()
                    -- 傳送到 Lobby.Teleport1
                    local teleport1 = Workspace.Lobby:FindFirstChild("Teleport1")
                    if teleport1 and isCherryHelpEnabled then
                        humanoidRootPart.CFrame = teleport1.CFrame
                        task.wait(0.3)
                    end
                    
                    local targetObject = nil
                    local moveOffset = 0
                    local waitInterval = 0.1 -- 預設間隔
                    
                    if cherryHelpMode == "第一、二任務" then
                        -- 找到目標玩家本體
                        local targetPlayer = game:GetService("Players"):FindFirstChild(targetName)
                        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                            targetObject = targetPlayer.Character.HumanoidRootPart
                            moveOffset = 5 -- 面前5單位
                            waitInterval = 0.1 -- 第一、二任務改為0.1秒間隔
                        end
                    else -- 第三、四任務
                        -- 找到目標櫻桃手套
                        targetObject = findTargetGlove(targetName)
                        moveOffset = 0 -- 直接到手套位置，不偏移
                        waitInterval = 0 -- 間隔時間為0
                    end
                    
                    -- 在找到目標後立即移動
                    if targetObject and isCherryHelpEnabled then
                        pcall(function()
                            if cherryHelpMode == "第一、二任務" and moveOffset > 0 and targetObject.Parent:FindFirstChild("HumanoidRootPart") then
                                -- 移動到目標面前
                                local targetPos = targetObject.Position
                                local targetLookDirection = targetObject.CFrame.LookVector
                                local newPos = targetPos + (targetLookDirection * moveOffset)
                                humanoidRootPart.CFrame = CFrame.new(newPos, targetPos)
                            else
                                -- 直接移動到目標位置（第三、四任務）
                                local targetPos = targetObject.Position
                                humanoidRootPart.CFrame = CFrame.new(targetPos)
                            end
                        end)
                        task.wait(0.2) -- 等待移動完成
                    end
                    
                    if targetObject and isCherryHelpEnabled then
                        local playerWorkspaceFolder = Workspace:FindFirstChild(LocalPlayer.Name)
                        local lastUpdateTime = tick()
                        
                        -- 持續移動直到檢測到被打中或ragdoll
                        while isCherryHelpEnabled and character.Parent and humanoid.Health > 0 and playerWorkspaceFolder do
                            
                            -- 檢查ragdoll狀態
                            if isInRagdoll(character) then
                                if cherryHelpMode == "第一、二任務" then
                                    -- 第一、二任務：執行重置流程
                                    task.wait(0.5) -- 等待0.5秒
                                    
                                    -- 安全傳送到指定坐標
                                    pcall(function()
                                        if humanoidRootPart and humanoidRootPart.Parent then
                                            humanoidRootPart.CFrame = CFrame.new(263, 13, 197)
                                        end
                                    end)
                                    
                                    task.wait(0.2)
                                    
                                    -- 安全重置
                                    pcall(function()
                                        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                                            LocalPlayer.Character.Humanoid:TakeDamage(LocalPlayer.Character.Humanoid.MaxHealth)
                                        end
                                    end)
                                    
                                    -- 等待重置完成和新角色載入
                                    local resetStartTime = tick()
                                    repeat
                                        task.wait(0.2)
                                        if tick() - resetStartTime > 3 then
                                            break
                                        end
                                    until not LocalPlayer.Character or LocalPlayer.Character.Humanoid.Health <= 0
                                    
                                    -- 等待新角色
                                    local newCharacter = nil
                                    local waitStartTime = tick()
                                    repeat
                                        task.wait(0.2)
                                        newCharacter = LocalPlayer.Character
                                        if tick() - waitStartTime > 3 then
                                            break
                                        end
                                    until newCharacter and newCharacter:FindFirstChild("HumanoidRootPart") and 
                                          newCharacter:FindFirstChild("Humanoid") and newCharacter.Humanoid.Health > 0
                                    
                                    -- 傳送到紅門並等待0.5秒
                                    pcall(function()
                                        local teleport1 = Workspace.Lobby:FindFirstChild("Teleport1")
                                        if teleport1 and newCharacter and newCharacter:FindFirstChild("HumanoidRootPart") then
                                            newCharacter.HumanoidRootPart.CFrame = teleport1.CFrame
                                            task.wait(0.5)
                                        end
                                    end)
                                    
                                    -- 重新找到目標並移動
                                    pcall(function()
                                        local targetPlayer = game:GetService("Players"):FindFirstChild(targetName)
                                        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                            local targetPos = targetPlayer.Character.HumanoidRootPart.Position
                                            local targetLookDirection = targetPlayer.Character.HumanoidRootPart.CFrame.LookVector
                                            local newPos = targetPos + (targetLookDirection * 5)
                                            newCharacter.HumanoidRootPart.CFrame = CFrame.new(newPos, targetPos)
                                        end
                                    end)
                                    
                                    task.wait(0.3)
                                else
                                    -- 第三、四任務：不重置，繼續移動到目標位置
                                    task.wait(0.1)
                                    pcall(function()
                                        local newTargetGlove = findTargetGlove(targetName)
                                        if newTargetGlove and newTargetGlove.Parent and humanoidRootPart and humanoidRootPart.Parent then
                                            local glovePos = newTargetGlove.Position
                                            humanoidRootPart.CFrame = CFrame.new(glovePos)
                                        end
                                    end)
                                end
                                break
                            end
                            
                            -- 檢查是否被打中 (如果有LastSlappedBy系統)
                            local lastSlappedBy = playerWorkspaceFolder:FindFirstChild("LastSlappedBy")
                            if lastSlappedBy and lastSlappedBy.Value == targetName then
                                if cherryHelpMode == "第一、二任務" then
                                    task.wait(0.5)
                                    
                                    -- 重置流程 (同ragdoll處理)
                                    pcall(function()
                                        if humanoidRootPart and humanoidRootPart.Parent then
                                            humanoidRootPart.CFrame = CFrame.new(263, 13, 197)
                                        end
                                    end)
                                    
                                    task.wait(0.2)
                                    
                                    pcall(function()
                                        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
                                            LocalPlayer.Character.Humanoid:TakeDamage(LocalPlayer.Character.Humanoid.MaxHealth)
                                        end
                                    end)
                                    
                                    local resetStartTime = tick()
                                    repeat
                                        task.wait(0.2)
                                        if tick() - resetStartTime > 3 then
                                            break
                                        end
                                    until not LocalPlayer.Character or LocalPlayer.Character.Humanoid.Health <= 0
                                    
                                    local newCharacter = nil
                                    local waitStartTime = tick()
                                    repeat
                                        task.wait(0.2)
                                        newCharacter = LocalPlayer.Character
                                        if tick() - waitStartTime > 3 then
                                            break
                                        end
                                    until newCharacter and newCharacter:FindFirstChild("HumanoidRootPart") and 
                                          newCharacter:FindFirstChild("Humanoid") and newCharacter.Humanoid.Health > 0
                                    
                                    pcall(function()
                                        local teleport1 = Workspace.Lobby:FindFirstChild("Teleport1")
                                        if teleport1 and newCharacter and newCharacter:FindFirstChild("HumanoidRootPart") then
                                            newCharacter.HumanoidRootPart.CFrame = teleport1.CFrame
                                            task.wait(0.5)
                                        end
                                    end)
                                    
                                    -- 重新找到目標並移動
                                    pcall(function()
                                        local targetPlayer = game:GetService("Players"):FindFirstChild(targetName)
                                        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                                            local targetPos = targetPlayer.Character.HumanoidRootPart.Position
                                            local targetLookDirection = targetPlayer.Character.HumanoidRootPart.CFrame.LookVector
                                            local newPos = targetPos + (targetLookDirection * 5)
                                            newCharacter.HumanoidRootPart.CFrame = CFrame.new(newPos, targetPos)
                                        end
                                    end)
                                    
                                    task.wait(0.3)
                                    break
                                else
                                    -- 第三、四任務 - 持續跟隨，不重置
                                    isCherryMovingLocked = true
                                    
                                    while isCherryHelpEnabled and isCherryMovingLocked do
                                        pcall(function()
                                            local targetGlove = findTargetGlove(targetName)
                                            
                                            if targetGlove and targetGlove.Parent then
                                                local glovePos = targetGlove.Position
                                                
                                                if humanoidRootPart and humanoidRootPart.Parent then
                                                    humanoidRootPart.CFrame = CFrame.new(glovePos)
                                                end
                                            end
                                        end)
                                        -- 第三、四任務間隔時間為0，直接繼續
                                    end
                                    break
                                end
                            end
                            
                            local currentTime = tick()
                            if currentTime - lastUpdateTime < 0.2 then
                                task.wait(0.1)
                                continue
                            end
                            lastUpdateTime = currentTime
                            
                            -- 重新尋找目標
                            if cherryHelpMode == "第一、二任務" then
                                local targetPlayer = game:GetService("Players"):FindFirstChild(targetName)
                                targetObject = targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
                            else
                                targetObject = findTargetGlove(targetName)
                            end
                            
                            if not (targetObject and targetObject.Parent) then
                                break
                            end
                            
                            -- 持續移動到目標位置
                            pcall(function()
                                if cherryHelpMode == "第一、二任務" then
                                    local targetPos = targetObject.Position
                                    local targetLookDirection = targetObject.CFrame.LookVector
                                    local newPos = targetPos + (targetLookDirection * 5)
                                    
                                    if (humanoidRootPart.Position - newPos).Magnitude > 1 then
                                        humanoidRootPart.CFrame = CFrame.new(newPos, targetPos)
                                    end
                                else
                                    -- 第三、四任務：直接移動到手套位置，不偏移
                                    local targetPos = targetObject.Position
                                    
                                    if (humanoidRootPart.Position - targetPos).Magnitude > 1 then
                                        humanoidRootPart.CFrame = CFrame.new(targetPos)
                                    end
                                end
                            end)
                            
                            task.wait(waitInterval)
                        end
                    end
                end)
                
                if isCherryHelpEnabled then
                    task.wait(1)
                end
            end
        end)
    elseif cherryHelpLoop then
        task.cancel(cherryHelpLoop)
        cherryHelpLoop = nil
        isCherryMovingLocked = false
    end
end)

-- 初始設定：隱藏其他分區，只顯示櫻桃分區
if barrierSection then
    barrierSection.Visible = false
end

-- 分區切換功能
Section5.MouseButton1Click:Connect(function()
    barrierSection.Visible = true
    cherrySection.Visible = false
end)

Section6.MouseButton1Click:Connect(function()
    barrierSection.Visible = false
    cherrySection.Visible = true
end)
